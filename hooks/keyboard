#!/bin/sh
# hooks/keyboard

if [ -z "$NULLINITRD_WORKDIR" ]; then
    echo "Error: NULLINITRD_WORKDIR not set"
    exit 1
fi

WORKDIR="$NULLINITRD_WORKDIR"

mkdir -p "$WORKDIR/etc"

if [ -f /etc/vconsole.conf ]; then
    cp /etc/vconsole.conf "$WORKDIR/etc/"
fi

KEYMAP=$(grep KEYMAP /etc/vconsole.conf 2>/dev/null | cut -d= -f2)
if [ -n "$KEYMAP" ]; then
    find /usr/share/kbd/keymaps -name "$KEYMAP.map.gz" -exec cp {} "$WORKDIR/lib/" \;
fi

for bin in loadkeys setfont; do
    BIN_PATH=$(command -v $bin)
    if [ -n "$BIN_PATH" ]; then
        cp "$BIN_PATH" "$WORKDIR/bin/"
        for lib in $(ldd "$BIN_PATH" | grep -o '/[^ ]*'); do
            if [ -f "$lib" ]; then
                cp "$lib" "$WORKDIR/lib/" 2>/dev/null || cp "$lib" "$WORKDIR/lib64/" 2>/dev/null
            fi
        done
    fi
done
