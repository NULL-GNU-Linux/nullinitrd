#!/bin/sh
# hooks/udev

if [ -z "$NULLINITRD_WORKDIR" ]; then
    echo "Error: NULLINITRD_WORKDIR not set"
    exit 1
fi

WORKDIR="$NULLINITRD_WORKDIR"

for bin in udevd udevadm systemd-udevd; do
    BIN_PATH=$(command -v $bin 2>/dev/null)
    if [ -n "$BIN_PATH" ]; then
        mkdir -p "$WORKDIR/sbin"
        cp "$BIN_PATH" "$WORKDIR/sbin/"
        
        for lib in $(ldd "$BIN_PATH" | grep -o '/[^ ]*'); do
            if [ -f "$lib" ]; then
                cp "$lib" "$WORKDIR/lib/" 2>/dev/null || cp "$lib" "$WORKDIR/lib64/" 2>/dev/null
            fi
        done
        break
    fi
done

mkdir -p "$WORKDIR/etc/udev/rules.d"
mkdir -p "$WORKDIR/lib/udev/rules.d"

if [ -d /lib/udev/rules.d ]; then
    cp /lib/udev/rules.d/*.rules "$WORKDIR/lib/udev/rules.d/" 2>/dev/null
fi

if [ -d /usr/lib/udev/rules.d ]; then
    cp /usr/lib/udev/rules.d/*.rules "$WORKDIR/lib/udev/rules.d/" 2>/dev/null
fi

INIT_FILE="$WORKDIR/init"
sed -i '/mount -t devtmpfs/a\
udevd --daemon\
udevadm trigger --action=add\
udevadm settle' "$INIT_FILE"
